name: Build Native Libraries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 0.1.0-pre)'
        required: true
        default: '0.1.0-pre'
      create_release:
        description: 'Create GitHub release'
        type: boolean
        default: true
  push:
    tags:
      - 'v*'

env:
  GODOT_VERSION: '4.4'
  SCONS_CACHE_LIMIT: 7168

jobs:
  build:
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64
          - platform: windows
            arch: x86_64
            target: template_release
            runner: windows-latest
            lib_name: godot.windows.template_release.dev.x86_64.shared_library.dll
            artifact_name: libgodot-win-x64-template_release
          - platform: windows
            arch: x86_64
            target: editor
            runner: windows-latest
            lib_name: godot.windows.editor.dev.x86_64.shared_library.dll
            artifact_name: libgodot-win-x64-editor

          # Linux x64
          - platform: linuxbsd
            arch: x86_64
            target: template_release
            runner: ubuntu-22.04
            lib_name: libgodot.linuxbsd.template_release.dev.x86_64.shared_library.so
            artifact_name: libgodot-linux-x64-template_release
          - platform: linuxbsd
            arch: x86_64
            target: editor
            runner: ubuntu-22.04
            lib_name: libgodot.linuxbsd.editor.dev.x86_64.shared_library.so
            artifact_name: libgodot-linux-x64-editor

          # macOS x64
          - platform: macos
            arch: x86_64
            target: template_release
            runner: macos-13
            lib_name: libgodot.macos.template_release.dev.x86_64.shared_library.dylib
            artifact_name: libgodot-osx-x64-template_release
          - platform: macos
            arch: x86_64
            target: editor
            runner: macos-13
            lib_name: libgodot.macos.editor.dev.x86_64.shared_library.dylib
            artifact_name: libgodot-osx-x64-editor

          # macOS arm64
          - platform: macos
            arch: arm64
            target: template_release
            runner: macos-14
            lib_name: libgodot.macos.template_release.dev.arm64.shared_library.dylib
            artifact_name: libgodot-osx-arm64-template_release
          - platform: macos
            arch: arm64
            target: editor
            runner: macos-14
            lib_name: libgodot.macos.editor.dev.arm64.shared_library.dylib
            artifact_name: libgodot-osx-arm64-editor

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scons rich

      # Linux-specific dependencies
      - name: Install Linux dependencies
        if: matrix.platform == 'linuxbsd'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libx11-dev \
            libxcursor-dev \
            libxinerama-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libxi-dev \
            libxrandr-dev \
            libwayland-dev

      # Windows-specific: Setup MSVC
      - name: Setup MSVC (Windows)
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1

      # macOS-specific: Setup Xcode
      - name: Setup Xcode (macOS)
        if: matrix.platform == 'macos'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      # Cache SCons build
      - name: Cache SCons
        uses: actions/cache@v4
        with:
          path: |
            godot/.scons_cache
            ~/.cache/scons
          key: ${{ matrix.artifact_name }}-${{ env.GODOT_VERSION }}-${{ github.sha }}
          restore-keys: |
            ${{ matrix.artifact_name }}-${{ env.GODOT_VERSION }}-

      # Build using build.py with platform/arch overrides
      - name: Build libgodot (${{ matrix.target }})
        run: |
          python build.py \
            --platform ${{ matrix.platform }} \
            --arch ${{ matrix.arch }} \
            --target ${{ matrix.target }} \
            --no-editor \
            --no-glue \
            --no-restore \
            --dev-build yes \
            --debug-symbols yes \
            --scu-build yes
        env:
          SCONS_CACHE: godot/.scons_cache

      # Create artifact zip
      - name: Package native library (Unix)
        if: matrix.platform != 'windows'
        run: |
          mkdir -p dist
          cp godot/bin/${{ matrix.lib_name }} dist/libgodot${{ matrix.platform == 'linuxbsd' && '.so' || '.dylib' }}
          cd dist
          zip -9 ${{ matrix.artifact_name }}.zip libgodot*

      - name: Package native library (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "godot/bin/${{ matrix.lib_name }}" "dist/libgodot.dll"
          Compress-Archive -Path "dist/libgodot.dll" -DestinationPath "dist/${{ matrix.artifact_name }}.zip" -CompressionLevel Optimal

      # Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.artifact_name }}.zip
          retention-days: 30

  # Create release with all artifacts
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -name "*.zip"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: twodog ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'pre') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
          files: |
            artifacts/**/*.zip
          body: |
            ## Native Libraries for twodog ${{ steps.version.outputs.version }}

            These native libgodot libraries are automatically downloaded by the twodog NuGet package.

            ### Included platforms:
            - Windows x64 (win-x64)
            - Linux x64 (linux-x64)
            - macOS x64 (osx-x64)
            - macOS arm64 (osx-arm64)

            ### Build types:
            - `template_release` - Optimized for shipping games (default)
            - `editor` - Full editor build for development

            ### Manual download:
            Download the appropriate zip for your platform and extract `libgodot.dll` / `libgodot.so` / `libgodot.dylib` to your project output directory.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
