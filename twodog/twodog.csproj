<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Library</OutputType>
    <TargetFramework>net8.0</TargetFramework>
    <IsTrimmable>true</IsTrimmable>
    <VerifyReferenceTrimCompatibility>true</VerifyReferenceTrimCompatibility>
  </PropertyGroup>

  <!-- Programming & Linkage Characteristics -->
  <PropertyGroup>
    <RootNamespace>twodog</RootNamespace>
    <Nullable>enable</Nullable>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
  </PropertyGroup>

  <!-- NuGet Package Metadata -->
  <PropertyGroup>
    <PackageId>twodog</PackageId>
    <Version>0.1.0-pre</Version>
    <Authors>2dog contributors</Authors>
    <Description>Embed Godot engine in your .NET applications. Native libgodot libraries are downloaded automatically on first build.</Description>
    <PackageLicenseExpression>MIT</PackageLicenseExpression>
    <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
    <IncludeSymbols>true</IncludeSymbols>
    <IsPackable>true</IsPackable>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
    <!-- Suppress NU5100: GodotSharp API DLLs are intentionally in contentFiles, not lib -->
    <NoWarn>$(NoWarn);NU5100</NoWarn>
  </PropertyGroup>

  <PropertyGroup>
    <GodotProjectDir>$(MSBuildProjectDirectory)/../project/</GodotProjectDir>
    <GodotBinDir>$(MSBuildProjectDirectory)/../godot/bin/</GodotBinDir>
  </PropertyGroup>
  
  <!-- Detect current OS for development builds -->
  <PropertyGroup>
    <IsLinux Condition="'$(IsLinux)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Linux)))">true</IsLinux>
    <IsWindows Condition="'$(IsWindows)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Windows)))">true</IsWindows>
    <IsOSX Condition="'$(IsOSX)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::OSX)))">true</IsOSX>
  </PropertyGroup>

  <!-- Package reference for compile-time API -->
  <ItemGroup>
    <PackageReference Version="4.6.0-beta" Include="GodotSharp" />
  </ItemGroup>

  <!-- Include MSBuild targets in the package -->
  <ItemGroup>
    <None Include="build\twodog.targets" Pack="true" PackagePath="build\" />
    <None Include="buildTransitive\twodog.targets" Pack="true" PackagePath="buildTransitive\" />
  </ItemGroup>

  <!--
    Include GodotSharp API assemblies in the package.
    These must be copied to GodotSharp/Api/<Config>/ at runtime because Godot's native
    code checks for directory existence before .NET is loaded (gd_mono.cpp).
  -->
  <ItemGroup>
    <!-- Debug configuration -->
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotSharp.dll"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotSharp.pdb"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Debug\GodotSharp.pdb')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotSharp.xml"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Debug\GodotSharp.xml')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotSharpEditor.dll"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Debug\GodotSharpEditor.dll')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotSharpEditor.pdb"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Debug\GodotSharpEditor.pdb')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotSharpEditor.xml"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Debug\GodotSharpEditor.xml')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotPlugins.dll"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotPlugins.pdb"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Debug\GodotPlugins.pdb')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Debug\GodotPlugins.runtimeconfig.json"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Debug\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Debug\GodotPlugins.runtimeconfig.json')" />
    <!-- Release configuration (if different from Debug) -->
    <Content Include="$(GodotBinDir)GodotSharp\Api\Release\GodotSharp.dll"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Release\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Release\GodotSharp.dll')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Release\GodotSharp.pdb"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Release\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Release\GodotSharp.pdb')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Release\GodotPlugins.dll"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Release\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Release\GodotPlugins.dll')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Release\GodotPlugins.pdb"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Release\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Release\GodotPlugins.pdb')" />
    <Content Include="$(GodotBinDir)GodotSharp\Api\Release\GodotPlugins.runtimeconfig.json"
             Pack="true"
             PackagePath="contentFiles\any\any\GodotSharp\Api\Release\"
             CopyToOutputDirectory="Never"
             Condition="Exists('$(GodotBinDir)GodotSharp\Api\Release\GodotPlugins.runtimeconfig.json')" />
  </ItemGroup>

  <!--
    Native libraries are NOT included in the package.
    They are downloaded automatically by MSBuild targets on first build.
    
    For local development of the twodog library itself:
    - Debug: Use editor dev build (expects Debug assemblies, includes debug features)
    - Release: Use template_release non-dev build (expects Release assemblies, optimized)
    - Package consumers will download the appropriate build via twodog.targets
  -->
  
  <!-- For local development of twodog: Skip native download -->
  <PropertyGroup>
    <TwoDogSkipNativeDownload>true</TwoDogSkipNativeDownload>
  </PropertyGroup>
  
  <!-- Debug configuration: Use editor dev build (expects Debug assemblies) -->
  <PropertyGroup Condition="'$(Configuration)' == 'Debug' Or '$(Configuration)' == ''">
    <TwoDogLocalNativeLib_Windows>$(GodotBinDir)godot.windows.editor.dev.x86_64.shared_library.dll</TwoDogLocalNativeLib_Windows>
    <TwoDogLocalNativeLib_Linux>$(GodotBinDir)libgodot.linuxbsd.editor.dev.x86_64.shared_library.so</TwoDogLocalNativeLib_Linux>
    <TwoDogLocalNativeLib_OSX>$(GodotBinDir)libgodot.macos.editor.dev.x86_64.shared_library.dylib</TwoDogLocalNativeLib_OSX>
  </PropertyGroup>
  
  <!-- Release configuration: Use template_release non-dev build (expects Release assemblies) -->
  <PropertyGroup Condition="'$(Configuration)' == 'Release'">
    <TwoDogLocalNativeLib_Windows>$(GodotBinDir)godot.windows.template_release.x86_64.shared_library.dll</TwoDogLocalNativeLib_Windows>
    <TwoDogLocalNativeLib_Linux>$(GodotBinDir)libgodot.linuxbsd.template_release.x86_64.shared_library.so</TwoDogLocalNativeLib_Linux>
    <TwoDogLocalNativeLib_OSX>$(GodotBinDir)libgodot.macos.template_release.x86_64.shared_library.dylib</TwoDogLocalNativeLib_OSX>
  </PropertyGroup>
  
  <!-- Copy local native lib to output for twodog library development -->
  <ItemGroup>
    <Content Include="$(TwoDogLocalNativeLib_Windows)"
             Pack="false"
             Link="libgodot.dll"
             CopyToOutputDirectory="PreserveNewest"
             Condition="'$(IsWindows)' == 'true' And Exists('$(TwoDogLocalNativeLib_Windows)')" />
    <Content Include="$(TwoDogLocalNativeLib_Linux)"
             Pack="false"
             Link="libgodot.so"
             CopyToOutputDirectory="PreserveNewest"
             Condition="'$(IsLinux)' == 'true' And Exists('$(TwoDogLocalNativeLib_Linux)')" />
    <Content Include="$(TwoDogLocalNativeLib_OSX)"
             Pack="false"
             Link="libgodot.dylib"
             CopyToOutputDirectory="PreserveNewest"
             Condition="'$(IsOSX)' == 'true' And Exists('$(TwoDogLocalNativeLib_OSX)')" />
  </ItemGroup>

  <!--
    For local development: Copy all GodotSharp API assemblies to output.
    This is required because Godot's native code checks for directory existence
    at the filesystem level before .NET is loaded.
  -->
  <Target Name="CopyGodotApiForLocalDev" AfterTargets="Build" Condition="'$(DesignTimeBuild)' != 'true'">
    <PropertyGroup>
      <TwoDogGodotApiConfiguration Condition="'$(Configuration)' == 'Release'">Release</TwoDogGodotApiConfiguration>
      <TwoDogGodotApiConfiguration Condition="'$(TwoDogGodotApiConfiguration)' == ''">Debug</TwoDogGodotApiConfiguration>
      <GodotApiDestPath>$(OutputPath)GodotSharp\Api\$(TwoDogGodotApiConfiguration)\</GodotApiDestPath>
      <GodotApiSrcPath>$(GodotBinDir)GodotSharp\Api\$(TwoDogGodotApiConfiguration)\</GodotApiSrcPath>
    </PropertyGroup>

    <ItemGroup>
      <GodotApiFiles Include="$(GodotApiSrcPath)*.dll" />
      <GodotApiFiles Include="$(GodotApiSrcPath)*.pdb" />
      <GodotApiFiles Include="$(GodotApiSrcPath)*.xml" />
      <GodotApiFiles Include="$(GodotApiSrcPath)*.runtimeconfig.json" />
    </ItemGroup>

    <MakeDir Directories="$(GodotApiDestPath)" />
    <Copy SourceFiles="@(GodotApiFiles)"
          DestinationFolder="$(GodotApiDestPath)"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="DeepClean" AfterTargets="Clean">
    <RemoveDir Directories="$(BaseIntermediateOutputPath)" />
    <RemoveDir Directories="$(BaseOutputPath)" />
  </Target>
</Project>
