<Project Sdk="Microsoft.NET.Sdk">
    <!-- Normalize output path to use PascalCase configuration folders regardless of -c casing -->
    <PropertyGroup>
        <_NormalizedConfig>$(Configuration)</_NormalizedConfig>
        <_NormalizedConfig Condition="$([System.String]::Equals('$(Configuration)','debug',StringComparison.OrdinalIgnoreCase))">Debug</_NormalizedConfig>
        <_NormalizedConfig Condition="$([System.String]::Equals('$(Configuration)','release',StringComparison.OrdinalIgnoreCase))">Release</_NormalizedConfig>
        <_NormalizedConfig Condition="$([System.String]::Equals('$(Configuration)','editor',StringComparison.OrdinalIgnoreCase))">Editor</_NormalizedConfig>
        <OutputPath>bin/$(_NormalizedConfig)/</OutputPath>
    </PropertyGroup>

    <PropertyGroup>
        <OutputType>Library</OutputType>
        <TargetFramework>net8.0</TargetFramework>
        <IsTrimmable>true</IsTrimmable>
        <VerifyReferenceTrimCompatibility>true</VerifyReferenceTrimCompatibility>
    </PropertyGroup>

    <!-- Programming & Linkage Characteristics -->
    <PropertyGroup>
        <RootNamespace>twodog</RootNamespace>
        <Nullable>enable</Nullable>
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    </PropertyGroup>

    <!-- NuGet Package Metadata -->
    <PropertyGroup>
        <PackageId>2dog</PackageId>
        <Version>0.1.0-pre</Version>
        <Authors>2dog contributors</Authors>
        <Description>Embed the Godot engine in your .NET applications. Reference the 2dog package and it will pull in the appropriate platform-specific package (2dog.win-x64, 2dog.linux-x64, or 2dog.osx-x64) for native library support.</Description>
        <PackageLicenseExpression>MIT</PackageLicenseExpression>
        <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
        <PackageOutputPath>$(MSBuildProjectDirectory)/../packages/</PackageOutputPath>
        <IncludeSymbols>true</IncludeSymbols>
        <IsPackable>true</IsPackable>
        <SymbolPackageFormat>snupkg</SymbolPackageFormat>
    </PropertyGroup>

    <PropertyGroup>
        <GodotBinDir>$(MSBuildProjectDirectory)/../godot/bin/</GodotBinDir>
    </PropertyGroup>

    <!-- Detect current OS for development builds -->
    <PropertyGroup>
        <IsLinux Condition="'$(IsLinux)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Linux)))">true</IsLinux>
        <IsWindows Condition="'$(IsWindows)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Windows)))">true</IsWindows>
        <IsOSX Condition="'$(IsOSX)' == '' and $([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::OSX)))">true</IsOSX>
    </PropertyGroup>

    <!-- Package reference for compile-time API -->
    <ItemGroup>
        <PackageReference Version="4.6.0" Include="GodotSharp"/>
    </ItemGroup>

    <!--
      Platform-specific native library packages (release variant).
      These are dependencies of the 2dog package, so consumers get them automatically.
      NuGet automatically selects the correct native library at runtime based on the RID.
      
      For debug/editor variants, reference the corresponding platform package explicitly
      (e.g., 2dog.win-x64.debug or 2dog.win-x64.editor) in your application project.
      
      NOTE: These PackageReferences are only included when packing (GeneratePackageOnBuild).
      For local development, native libraries are handled by the Content items below.
    -->
    <ItemGroup Condition="'$(GenerateNuspecDependency)' == 'true' Or '$(NuspecFile)' != ''">
        <PackageReference Include="2dog.win-x64" Version="$(Version)" PrivateAssets="none"/>
        <PackageReference Include="2dog.linux-x64" Version="$(Version)" PrivateAssets="none"/>
        <PackageReference Include="2dog.osx-x64" Version="$(Version)" PrivateAssets="none"/>
    </ItemGroup>

    <!-- Include MSBuild targets in the package -->
    <ItemGroup>
        <None Include="build\2dog.targets" Pack="true" PackagePath="build\"/>
        <None Include="buildTransitive\2dog.targets" Pack="true" PackagePath="buildTransitive\"/>
        <None Remove="twodog.osx-x64\**"/>
        <None Remove="twodog.win-x64\**"/>
    </ItemGroup>

    <!--
      Native libraries are NOT embedded in this package.
      They are provided by separate platform-specific packages:
        - 2dog.win-x64 / 2dog.linux-x64 / 2dog.osx-x64: template_release builds
        - 2dog.win-x64.debug / 2dog.linux-x64.debug / 2dog.osx-x64.debug: template_debug builds
        - 2dog.win-x64.editor / 2dog.linux-x64.editor / 2dog.osx-x64.editor: editor builds
  
      When you install the 2dog NuGet package, the release variant platform packages
      are added as normal dependencies, so you usually only need to reference 2dog.
  
      For local development of the twodog library itself:
        - Debug: Use template_debug build (debugging enabled)
        - Editor: Use editor build (full editor features, TOOLS_ENABLED)
        - Release: Use template_release build (optimized)
    -->

    <!-- Debug configuration: Use template_debug build -->
    <PropertyGroup Condition="'$(Configuration)' == 'Debug' Or '$(Configuration)' == ''">
        <TwoDogLocalNativeLib_Windows>$(GodotBinDir)godot.windows.template_debug.x86_64.shared_library.dll</TwoDogLocalNativeLib_Windows>
        <TwoDogLocalNativeLib_Linux>$(GodotBinDir)libgodot.linuxbsd.template_debug.x86_64.shared_library.so</TwoDogLocalNativeLib_Linux>
        <TwoDogLocalNativeLib_OSX>$(GodotBinDir)libgodot.macos.template_debug.x86_64.shared_library.dylib</TwoDogLocalNativeLib_OSX>
    </PropertyGroup>

    <!-- Editor configuration: Use editor build (TOOLS_ENABLED) -->
    <PropertyGroup Condition="'$(Configuration)' == 'Editor'">
        <TwoDogLocalNativeLib_Windows>$(GodotBinDir)godot.windows.editor.x86_64.shared_library.dll</TwoDogLocalNativeLib_Windows>
        <TwoDogLocalNativeLib_Linux>$(GodotBinDir)libgodot.linuxbsd.editor.x86_64.shared_library.so</TwoDogLocalNativeLib_Linux>
        <TwoDogLocalNativeLib_OSX>$(GodotBinDir)libgodot.macos.editor.x86_64.shared_library.dylib</TwoDogLocalNativeLib_OSX>
    </PropertyGroup>

    <!-- Release configuration: Use template_release build (optimized) -->
    <PropertyGroup Condition="'$(Configuration)' == 'Release'">
        <TwoDogLocalNativeLib_Windows>$(GodotBinDir)godot.windows.template_release.x86_64.shared_library.dll</TwoDogLocalNativeLib_Windows>
        <TwoDogLocalNativeLib_Linux>$(GodotBinDir)libgodot.linuxbsd.template_release.x86_64.shared_library.so</TwoDogLocalNativeLib_Linux>
        <TwoDogLocalNativeLib_OSX>$(GodotBinDir)libgodot.macos.template_release.x86_64.shared_library.dylib</TwoDogLocalNativeLib_OSX>
    </PropertyGroup>

    <!-- Determine which native library to use based on current OS -->
    <PropertyGroup>
        <TwoDogCurrentNativeLib Condition="'$(IsWindows)' == 'true'">$(TwoDogLocalNativeLib_Windows)</TwoDogCurrentNativeLib>
        <TwoDogCurrentNativeLib Condition="'$(IsLinux)' == 'true'">$(TwoDogLocalNativeLib_Linux)</TwoDogCurrentNativeLib>
        <TwoDogCurrentNativeLib Condition="'$(IsOSX)' == 'true'">$(TwoDogLocalNativeLib_OSX)</TwoDogCurrentNativeLib>
        <TwoDogCurrentPlatform Condition="'$(IsWindows)' == 'true'">Windows</TwoDogCurrentPlatform>
        <TwoDogCurrentPlatform Condition="'$(IsLinux)' == 'true'">Linux</TwoDogCurrentPlatform>
        <TwoDogCurrentPlatform Condition="'$(IsOSX)' == 'true'">macOS</TwoDogCurrentPlatform>
    </PropertyGroup>

    <!-- Copy local native lib to output for twodog library development -->
    <ItemGroup>
        <Content Include="$(TwoDogLocalNativeLib_Windows)" Pack="false" Link="libgodot.dll" CopyToOutputDirectory="PreserveNewest" Condition="'$(IsWindows)' == 'true' And Exists('$(TwoDogLocalNativeLib_Windows)')"/>
        <Content Include="$(TwoDogLocalNativeLib_Linux)" Pack="false" Link="libgodot.so" CopyToOutputDirectory="PreserveNewest" Condition="'$(IsLinux)' == 'true' And Exists('$(TwoDogLocalNativeLib_Linux)')"/>
        <Content Include="$(TwoDogLocalNativeLib_OSX)" Pack="false" Link="libgodot.dylib" CopyToOutputDirectory="PreserveNewest" Condition="'$(IsOSX)' == 'true' And Exists('$(TwoDogLocalNativeLib_OSX)')"/>
    </ItemGroup>

    <Target Name="DeepClean" AfterTargets="Clean">
        <RemoveDir Directories="$(BaseIntermediateOutputPath)"/>
        <RemoveDir Directories="$(BaseOutputPath)"/>
    </Target>
</Project>
